<!DOCTYPE html>
<html>
<head>
    <title>ç³»ç»Ÿç™»å½•</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            /* ç™»å½•é¡µå•ç‹¬çš„èƒŒæ™¯æ ·å¼ï¼Œæˆ–è€…å¤ç”¨å…¨å±€çš„ */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            width: 350px;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
        }
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab-item { padding: 10px 20px; cursor: pointer; color: #888; font-weight: bold; transition: all 0.3s; }
        .tab-item.active { color: #ff69b4; border-bottom: 2px solid #ff69b4; }
        .tab-item:hover { color: #ff85c2; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .btn-primary { width: 100%; padding: 12px; background: #ff69b4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 15px; transition: background 0.2s; }
        .btn-primary:hover { background: #ff85c2; }

        /* æ³¨å†Œä¸“å±å­—æ®µçš„æ ·å¼ */
        .register-only {
            text-align: left;
            border-top: 1px dashed #eee;
            margin-top: 10px;
            padding-top: 10px;
            display: none; /* é»˜è®¤éšè— */
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="tabs">
            <div class="tab-item active" onclick="switchTab('login')">ç™»å½•</div>
            <div class="tab-item" onclick="switchTab('register')">æ³¨å†Œæ–°è´¦å·</div>
        </div>

        <h3 id="formTitle" style="color:#333; margin-bottom:20px;">ç®¡ç†å‘˜ç™»å½•</h3>
        
        <input type="text" id="user" placeholder="ç”¨æˆ·å (ç™»å½•è´¦å·)">
        <input type="password" id="pass" placeholder="å¯†ç ">
        
        <div id="registerFields" class="register-only">
            <p style="font-size:12px; color:#666; margin: 5px 0;">ğŸ‘‡ è®¾ç½®ä½ çš„ä¸“å±é“¾æ¥</p>
            <div class="input-group">
                <input type="text" id="subdomain" placeholder="lisa" style="margin:0; text-align:right;">
                <span style="color:#888; font-size:14px; white-space: nowrap;">.songlist.icu</span>
            </div>
            
            <p style="font-size:12px; color:#666; margin: 10px 0 5px;">ğŸ‘‡ ä¸»é¡µæ˜¾ç¤ºçš„åç§°</p>
            <input type="text" id="displayName" placeholder="ä¸»æ’­æ˜µç§° (å¦‚: Lisa_Official)">
        </div>

        <button class="btn-primary" id="actionBtn" onclick="handleAuth()">ç™»å½•</button>
        <p id="msg" style="color: red; margin-top: 10px; font-size: 13px; min-height: 20px;"></p>
    </div>

    <script>
        let isLoginMode = true;

        // åˆ‡æ¢ ç™»å½•/æ³¨å†Œ æ¨¡å¼
        function switchTab(mode) {
            isLoginMode = (mode === 'login');
            
            // åˆ‡æ¢ Tab æ ·å¼
            const tabs = document.querySelectorAll('.tab-item');
            tabs[0].className = isLoginMode ? 'tab-item active' : 'tab-item';
            tabs[1].className = !isLoginMode ? 'tab-item active' : 'tab-item';
            
            // åˆ‡æ¢æ ‡é¢˜å’ŒæŒ‰é’®æ–‡å­—
            document.getElementById('formTitle').innerText = isLoginMode ? "ç®¡ç†å‘˜ç™»å½•" : "æ³¨å†Œæ–°è´¦å·";
            document.getElementById('actionBtn').innerText = isLoginMode ? "ç™»å½•" : "ç«‹å³æ³¨å†Œ";
            document.getElementById('msg').innerText = "";

            // æ˜¾ç¤ºæˆ–éšè—æ³¨å†Œä¸“ç”¨å­—æ®µ
            const regFields = document.getElementById('registerFields');
            if (isLoginMode) {
                regFields.style.display = 'none';
                regFields.classList.remove('fade-in');
            } else {
                regFields.style.display = 'block';
                // åŠ ä¸ªç®€å•çš„æ·¡å…¥åŠ¨ç”»æ•ˆæœ(å¯é€‰)
                regFields.style.opacity = 0;
                setTimeout(() => regFields.style.opacity = 1, 10);
                regFields.style.transition = 'opacity 0.3s';
            }
        }

        async function handleAuth() {
            const username = document.getElementById('user').value;
            const password = document.getElementById('pass').value;
            const msg = document.getElementById('msg');
            const btn = document.getElementById('actionBtn');
            
            // è·å–æ³¨å†Œä¸“ç”¨å­—æ®µ
            const subdomain = document.getElementById('subdomain').value;
            const displayName = document.getElementById('displayName').value;

            // ç®€å•æ ¡éªŒ
            if (!username || !password) {
                msg.innerText = "è¯·è¾“å…¥è´¦å·å’Œå¯†ç ";
                return;
            }
            if (!isLoginMode && !subdomain) {
                msg.innerText = "æ³¨å†Œå¿…é¡»å¡«å†™ä¸“å±åŸŸååç¼€";
                return;
            }

            const endpoint = isLoginMode ? '/api/login' : '/api/register';
            
            // æ„å»ºå‘é€ç»™åç«¯çš„æ•°æ®
            const payload = { username, password };
            if (!isLoginMode) {
                payload.subdomain = subdomain;
                payload.display_name = displayName;
            }

            // æŒ‰é’®é˜²æŠ–
            btn.disabled = true;
            btn.innerText = "å¤„ç†ä¸­...";

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    if (isLoginMode) {
                        // === ç™»å½•æˆåŠŸ ===
                        // data.subdomain æ˜¯åç«¯è¿”å›çš„ï¼Œä¾‹å¦‚ 'lisa'
                        // æˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹ï¼Œå¦‚æœå½“å‰è®¿é—®çš„åŸŸåå·²ç»æ˜¯æ­£ç¡®çš„ï¼Œå°±ç›´æ¥è·³ admin.html
                        // å¦‚æœæ˜¯åœ¨ä¸»åŸŸåç™»å½•çš„ï¼Œå°±å¸®ä»–è·³åˆ°å­åŸŸåå»
                        
                        const currentHost = window.location.host; // ä¾‹å¦‚ songlist.icu æˆ– lisa.songlist.icu
                        const targetSubdomain = data.subdomain;
                        
                        // ç®€å•çš„åˆ¤æ–­ï¼šå¦‚æœå½“å‰åŸŸåä¸åŒ…å«è¿™ä¸ªå­åŸŸåï¼Œå°±è·³è½¬
                        // æ³¨æ„ï¼šæœ¬åœ° localhost å¼€å‘æ—¶ï¼Œä¸éœ€è¦è·³åŸŸåï¼Œç›´æ¥è¿›
                        if (currentHost.includes('localhost') || currentHost.includes('127.0.0.1')) {
                            window.location.href = '/admin.html';
                        } else if (!currentHost.startsWith(targetSubdomain + '.')) {
                            // è·³è½¬åˆ°ä¸“å±åŸŸå (å‡è®¾ä¸»åŸŸåæ˜¯ songlist.icu)
                            // è¿™é‡Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸»åŸŸåæ˜¯ä»€ä¹ˆï¼Œç®€å•åšæ³•æ˜¯å–å½“å‰åŸŸåçš„ååŠæ®µï¼Œæˆ–è€…å†™æ­»
                            // æ¯”è¾ƒç¨³å¦¥çš„æ–¹å¼æ˜¯è®©åç«¯è¿”å›å®Œæ•´ URLï¼Œè¿™é‡Œæ¼”ç¤ºç®€å•çš„æ‹¼æ¥
                            const mainDomain = 'songlist.icu'; 
                            window.location.href = `http://${targetSubdomain}.${mainDomain}/admin.html`;
                        } else {
                            // å·²ç»æ˜¯å­åŸŸåäº†ï¼Œç›´æ¥è¿›
                            window.location.href = '/admin.html';
                        }

                    } else {
                        // === æ³¨å†ŒæˆåŠŸ ===
                        alert('æ³¨å†ŒæˆåŠŸï¼å¿«å»ç™»å½•å§~');
                        switchTab('login');
                        // è‡ªåŠ¨å¡«å…¥åˆšæ‰æ³¨å†Œçš„è´¦å·
                        document.getElementById('user').value = username;
                        document.getElementById('pass').value = password;
                    }
                } else {
                    msg.innerText = data.error || 'æ“ä½œå¤±è´¥';
                }
            } catch (err) {
                console.error(err);
                msg.innerText = "ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•";
            } finally {
                btn.disabled = false;
                btn.innerText = isLoginMode ? "ç™»å½•" : "ç«‹å³æ³¨å†Œ";
            }
        }
        
        // å›è½¦é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleAuth(); });
    </script>
</body>
</html>