<!DOCTYPE html>
<html>
<head>
    <title>æ­Œå•åå°ç®¡ç†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { display: block !important; height: auto !important; padding: 20px; overflow-y: auto; background-image: none !important; background-color: #f4f4f4; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.95); padding: 15px 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .admin-layout { display: grid; grid-template-columns: 1fr 320px; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: start; }
        @media (max-width: 850px) { .admin-layout { grid-template-columns: 1fr; } }
        .main-column, .side-column { display: flex; flex-direction: column; gap: 20px; }
        .card { background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eb6cc9; transition: background 0.2s; color: #333; }
        .list-row:hover { background: #fa8cf4; }
        input, textarea { width: 100%; padding: 8px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .action-link { cursor: pointer; color: #ff69b4; margin-left: 15px; font-weight: bold; text-decoration: underline; }
        .modal-bg { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }
        .pass-box { background: white; padding: 30px; border-radius: 10px; width: 300px; text-align: center; }
        #adminList { max-height: 600px; overflow-y: auto; }
        .btn-pink { background:#ff69b4; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
        .btn-green { background:#4CAF50; color:white; padding:10px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; }
        .btn-blue { background:#1890ff; color:white; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; font-size:12px; margin-bottom: 15px; }
        label { font-size:12px; font-weight:bold; display:block; margin-bottom:5px; }
    </style>
</head>
<body>

    <div class="admin-header">
        <h2 style="margin:0; color:#333;">åå°ç®¡ç†ç³»ç»Ÿ</h2>
        <div>
            <span class="action-link" onclick="openPassModal()">ä¿®æ”¹å¯†ç </span>
            <a href="/api/logout" class="action-link" style="color: #ff4d4f;">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <div class="admin-layout">
        <div class="main-column">
            <div class="card">
                <h3 style="margin-top:0; border-bottom: 1px solid #eee; padding-bottom: 10px;">æ–°å¢æ­Œæ›² (å•é¦–)</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="title" placeholder="æ­Œæ›²åç§° (å¿…å¡«)" style="flex: 2;">
                    <input type="text" id="category" placeholder="åˆ†ç±» (å¦‚: æµè¡Œ)" style="flex: 1;">
                </div>
                <input type="text" id="url" placeholder="åˆ‡ç‰‡è§†é¢‘ URL (é€‰å¡«, Bç«™é“¾æ¥)">
                <button onclick="addSong()" class="btn-pink" style="width:100%; font-size: 16px;">âœ¨ æ·»åŠ æ­Œæ›²</button>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin:0">ç°æœ‰æ­Œæ›²åˆ—è¡¨</h3>
                    <button onclick="loadAdminList()" style="color: #1890ff; border:none; background:none; cursor:pointer;">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div id="adminList">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <div class="side-column">
            <div class="card">
                <h3 style="margin-top:0; color: #4CAF50;">æ‰¹é‡å¯¼å…¥ (Excel)</h3>
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <button onclick="uploadExcel()" id="uploadBtn" class="btn-green" style="width:100%;">ğŸ“‚ å¼€å§‹ä¸Šä¼ </button>
                <div style="margin-top:15px; text-align:center; border-top: 1px solid #eee; padding-top: 10px;">
                    <a href="#" onclick="downloadTemplate()" style="font-size:12px; color:#1890ff; text-decoration: none;">â¬‡ï¸ ä¸‹è½½å¯¼å…¥æ¨¡æ¿</a>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px; border-top: 4px solid #ff69b4;">
                <h3 style="margin-top:0; color: #ff69b4;">ğŸ¨ è£…ä¿®æˆ‘çš„ä¸»é¡µ</h3>
                
                <label>ä¸»æ’­æ˜¾ç¤ºåç§°</label>
                <input type="text" id="settingName" placeholder="å¦‚: Lisaè€å©†">
                
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;">
                        <label>ä¸»é¢˜è‰² (ä¸»è‰²è°ƒ)</label>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="color" id="settingColor" style="height:30px; width:50px; padding:0; border:none;">
                            <span id="colorVal" style="font-size:10px; color:#888;"></span>
                        </div>
                    </div>
                    <div style="flex:1;">
                        <label>æŒ‰é’®è‰² (ç®­å¤´æŒ‡çš„)</label>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="color" id="settingBtnColor" style="height:30px; width:50px; padding:0; border:none;">
                            <span id="btnColorVal" style="font-size:10px; color:#888;"></span>
                        </div>
                    </div>
                </div>

                <label>å¤´åƒè®¾ç½®</label>
                <div style="display:flex; gap: 5px;">
                    <input type="text" id="settingAvatar" placeholder="å›¾ç‰‡é“¾æ¥" style="flex:1;">
                    <input type="file" id="avatarFile" accept="image/*" style="display:none" onchange="uploadImage('avatarFile', 'settingAvatar')">
                    <button onclick="document.getElementById('avatarFile').click()" class="btn-blue">ä¸Šä¼ </button>
                </div>

                <label>èƒŒæ™¯å›¾ç‰‡è®¾ç½®</label>
                <div style="display:flex; gap: 5px;">
                    <input type="text" id="settingBg" placeholder="èƒŒæ™¯å›¾é“¾æ¥" style="flex:1;">
                    <input type="file" id="bgFile" accept="image/*" style="display:none" onchange="uploadImage('bgFile', 'settingBg')">
                    <button onclick="document.getElementById('bgFile').click()" class="btn-blue">ä¸Šä¼ </button>
                </div>

                <label>"è¿”å›é¡¶éƒ¨"å›¾æ ‡ (åœ†åœˆéƒ¨åˆ†)</label>
                <div style="display:flex; gap: 5px;">
                    <input type="text" id="settingTopIcon" placeholder="å›¾æ ‡é“¾æ¥" style="flex:1;">
                    <input type="file" id="topIconFile" accept="image/*" style="display:none" onchange="uploadImage('topIconFile', 'settingTopIcon')">
                    <button onclick="document.getElementById('topIconFile').click()" class="btn-blue">ä¸Šä¼ </button>
                </div>

                <label>ä¸ªäººä»‹ç»</label>
                <textarea id="settingIntro" rows="3" placeholder="å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯..."></textarea>
                
                <label>Bç«™é“¾æ¥</label>
                <input type="text" id="settingBiliSpace" placeholder="ä¸ªäººç©ºé—´ URL">
                <input type="text" id="settingBiliLive" placeholder="ç›´æ’­é—´ URL">

                <button onclick="saveSettings()" id="saveBtn" class="btn-pink" style="width:100%;">ğŸ’¾ ä¿å­˜è£…ä¿®è®¾ç½®</button>
            </div>
            <div class="card" style="text-align: center; color: #888; font-size: 12px;"><p>Designed by songlist-qingfeng</p></div>
        </div>
    </div> 

    <div id="passModal" class="modal-bg">
        <div class="pass-box">
            <h3>ä¿®æ”¹å¯†ç </h3>
            <input type="password" id="newPass" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
            <button onclick="changePassword()" class="btn-pink" style="width:100%;">ç¡®è®¤ä¿®æ”¹</button>
            <button onclick="closePassModal()" style="background:#ccc; color:#333; padding:10px; width:100%; border:none; border-radius:5px; cursor:pointer; margin-top:10px;">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // é€šç”¨å›¾ç‰‡ä¸Šä¼ 
        async function uploadImage(fileId, inputId) {
            const fileInput = document.getElementById(fileId);
            const targetInput = document.getElementById(inputId);
            const file = fileInput.files[0];
            if(!file) return;

            const formData = new FormData();
            formData.append('file', file);
            
            const oldVal = targetInput.value;
            targetInput.value = "ä¸Šä¼ ä¸­...";

            try {
                const res = await fetch('/api/upload-image', { method: 'POST', body: formData });
                const data = await res.json();
                if(res.ok) { targetInput.value = data.url; } 
                else { alert('ä¸Šä¼ å¤±è´¥'); targetInput.value = oldVal; }
            } catch(e) { alert('ç½‘ç»œé”™è¯¯'); targetInput.value = oldVal; }
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/site-info');
                const data = await res.json();
                document.getElementById('settingName').value = data.display_name || '';
                document.getElementById('settingAvatar').value = data.avatar_url || '';
                document.getElementById('settingIntro').value = data.intro || '';
                document.getElementById('settingColor').value = data.theme_color || '#fc9ee0';
                document.getElementById('colorVal').innerText = data.theme_color || '';
                
                document.getElementById('settingBtnColor').value = data.button_color || data.theme_color || '#fc9ee0';
                document.getElementById('settingBg').value = data.background_url || '';
                document.getElementById('settingTopIcon').value = data.back_to_top_url || '';

                document.getElementById('settingBiliSpace').value = data.bili_space_url || '';
                document.getElementById('settingBiliLive').value = data.bili_live_url || '';
                
                if(data.theme_color) document.querySelectorAll('.btn-pink').forEach(b => b.style.backgroundColor = data.theme_color);
            } catch(e) { console.error('åŠ è½½è®¾ç½®å¤±è´¥', e); }
        }

        async function saveSettings() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = 'ä¿å­˜ä¸­...'; btn.disabled = true;
            const payload = {
                display_name: document.getElementById('settingName').value,
                avatar_url: document.getElementById('settingAvatar').value,
                intro: document.getElementById('settingIntro').value,
                theme_color: document.getElementById('settingColor').value,
                bili_space_url: document.getElementById('settingBiliSpace').value,
                bili_live_url: document.getElementById('settingBiliLive').value,
                // æ–°å­—æ®µ
                background_url: document.getElementById('settingBg').value,
                button_color: document.getElementById('settingBtnColor').value,
                back_to_top_url: document.getElementById('settingTopIcon').value
            };
            try {
                const res = await fetch('/api/site-info', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if(res.ok) { alert('è£…ä¿®ä¿å­˜æˆåŠŸï¼'); } else { alert('ä¿å­˜å¤±è´¥'); }
            } catch(e) { alert('ç½‘ç»œé”™è¯¯'); } finally { btn.innerText = 'ğŸ’¾ ä¿å­˜è£…ä¿®è®¾ç½®'; btn.disabled = false; }
        }

        // å…¶ä»–å‡½æ•°ä¿æŒä¸å˜
        async function loadAdminList() {
            try {
                const res = await fetch('/api/songs');
                if (res.status === 401 || res.redirected) { window.location.href = '/login.html'; return; }
                const songs = await res.json();
                const container = document.getElementById('adminList');
                container.innerHTML = '';
                if(songs.length === 0) { container.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">æš‚æ— æ­Œæ›²</div>'; return; }
                songs.forEach(song => {
                    const div = document.createElement('div');
                    div.className = 'list-row';
                    div.innerHTML = `<div style="flex:1; display:flex; align-items:center; gap: 10px;"><span style="font-weight:bold; font-size: 15px; color: #333;">${song.title}</span><span style="font-size:12px; background:#f0f0f0; padding: 2px 6px; border-radius: 4px; color:#666;">${song.category || 'é»˜è®¤'}</span>${song.video_url ? '<a href="'+song.video_url+'" target="_blank" style="font-size:12px; color:#4CAF50; text-decoration:none;">ğŸ“º åˆ‡ç‰‡</a>' : ''}</div><button onclick="deleteSong(${song.id})" style="background:#ff4d4f; color:white; border:none; padding:6px 15px; border-radius:4px; cursor:pointer; font-size: 12px;">åˆ é™¤</button>`;
                    container.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }
        async function addSong() {
            const title = document.getElementById('title').value; const category = document.getElementById('category').value; const video_url = document.getElementById('url').value;
            if(!title) return alert('æ­Œåå¿…å¡«');
            const res = await fetch('/api/songs', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title, category, video_url }) });
            if(res.ok) { document.getElementById('title').value = ''; document.getElementById('url').value = ''; loadAdminList(); } else { alert('æ·»åŠ å¤±è´¥'); }
        }
        async function deleteSong(id) { if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { await fetch(`/api/songs/${id}`, { method: 'DELETE' }); loadAdminList(); } }
        async function uploadExcel() {
            const fileInput = document.getElementById('excelFile'); const file = fileInput.files[0]; const btn = document.getElementById('uploadBtn');
            if (!file) return alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼');
            const formData = new FormData(); formData.append('file', file);
            btn.innerText = 'â³...'; btn.disabled = true;
            try { const res = await fetch('/api/upload-excel', { method: 'POST', body: formData }); const data = await res.json(); if (res.ok) { alert(`æˆåŠŸå¯¼å…¥ ${data.count} é¦–`); fileInput.value = ''; loadAdminList(); } else { alert('å¤±è´¥: ' + data.error); } } catch (err) { alert('é”™è¯¯'); } finally { btn.innerText = 'ğŸ“‚ å¼€å§‹ä¸Šä¼ '; btn.disabled = false; }
        }
        function downloadTemplate() {
            const data = [["SCä»·æ ¼", "æ­Œå", "æ­Œæ‰‹", "åˆ†ç±»", "æ­Œåˆ‡é“¾æ¥", "æ ‡ç­¾"], [300, "æµ‹è¯•", "æµ‹è¯•", "æµè¡Œ", "", ""]];
            const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "æ¨¡æ¿"); XLSX.writeFile(wb, "æ¨¡æ¿.xlsx");
        }
        function openPassModal() { document.getElementById('passModal').style.display = 'flex'; }
        function closePassModal() { document.getElementById('passModal').style.display = 'none'; }
        async function changePassword() {
            const newPassword = document.getElementById('newPass').value; if(!newPassword) return alert('å¯†ç ä¸ºç©º');
            const res = await fetch('/api/change-password', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ newPassword }) });
            if(res.ok) { alert('ä¿®æ”¹æˆåŠŸ'); closePassModal(); } else { alert('å¤±è´¥'); }
        }
        
        // é¢œè‰²ç›‘å¬
        document.getElementById('settingColor').addEventListener('input', (e) => document.getElementById('colorVal').innerText = e.target.value);
        document.getElementById('settingBtnColor').addEventListener('input', (e) => document.getElementById('btnColorVal').innerText = e.target.value);

        loadSettings();
        loadAdminList();
    </script>
</body>
</html>